# Current housing gaps {#sec-current-gaps}

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

# Load common script
source("_common.R")
source("r/affordcalc.R")

# Load other packages other than tidyverse and hdatools
library(sf)
library(leaflet)
library(htmltools)
library(htmlwidgets)
library(patchwork)
library(tidycensus)
library(srvyr)

# Household records only
pums_faar_hh <- read_rds("data/pums/pums_faar.rds") |> filter(SPORDER == 1)

# Source caption for most plots
pums_cap <- "**Source:** HDAdvisors calculations of 2018-2022 ACS 5-year data."

faar_chas <- read_rds("data/tb_18_match.rds")

```

## Overview

Monthly housing costs show substantial variation across income bands in the Fredericksburg region. Maximum affordable housing costs scale proportionally with Area Median Income (AMI), ranging from about \$1,000 monthly for households below 30% AMI to over \$4,000 for those above 120% AMI.

However, actual current housing costs demonstrate a compressed range between approximately \$1,500 and \$2,500 monthly across all income bands, creating particular affordability challenges for lower-income households.

```{r}

fig_subtitle1 <- paste(
  "Range of monthly",
  "<span style='color: #445ca9'><b>maximum affordable</b></span> and",
  "<span style='color: #8baeaa'><b>actual current</b></span>",
  "housing costs"
)

pums_faar_hh |> 
  filter(hh_income > 0) |>
  mutate(tenure = paste0(tenure, "s")) |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "Core workforce",
      .default = "Not core workforce"
    ),
    costs = case_when(
      cost_own == -1 ~ cost_rent,
      .default = cost_own
    )
  ) |> 
  mutate(max_hsg_cost = hh_income/12 * 0.3) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(ami_faar) |> 
  summarise(
    cost_wm = survey_median(costs, vartype = "cv"),
    cost_q = survey_quantile(costs, c(0.25, 0.75)),
    max_wm = survey_median(max_hsg_cost, vartype = "cv"),
    max_q = survey_quantile(max_hsg_cost, c(0.25, 0.75)),
  ) |> 
  ungroup() |> 
  pivot_longer(
    cols = 2:13,
    names_to = "stat",
    values_to = "value"
  ) |> 
  mutate(
    type = case_when(
      str_detect(stat, "cost") ~ "Housing cost",
      .default = "Max cost"
    ), .after = 1
  ) |> 
  mutate(
    stat = str_remove_all(stat, "cost_|max_")
  ) |> 
  pivot_wider(
    names_from = stat,
    values_from = value
  ) |> 
  ggplot(aes(x = wm, y = ami_faar, color = type)) +
  geom_point(size = rel(2), position = position_dodge2(0.5)) +
  geom_segment(
    aes(y = ami_faar, x = q_q25, xend = q_q75),
    linewidth = rel(1.5),
    lineend = "round",
    alpha = 0.8,
    position = position_dodge2(0.5)
  ) +
  scale_color_hda(-1) +
  scale_x_continuous(
    limits = c(100, 5800),
    breaks = seq(1000, 5000, 1000),
    expand = c(0, 0),
    labels = label_dollar(),
    position = "top"
  ) +
  labs(
    title = "Affordable and actual housing costs by AMI",
    x = "Lines show range containing 50% of typical values",
    subtitle = fig_subtitle1,
    caption = pums_cap
  ) +
  theme_hda(
    flip_gridlines = T,
    axis.text.y = element_text(size = rel(1.2)),
    axis.title.x = element_text()
  )



```

As a result of this mismatch, housing cost burdens reveal stark disparities between income groups, with similar patterns varying between core workforce and other households. Among core workforce households, severe cost burdens affect about two-thirds of those below 30% AMI, while an additional 44% of households between 30-50% AMI face moderate cost burdens.

The burden decreases significantly for higher income brackets, with only 7-8% of households above 80% AMI experiencing any cost burden. Similar patterns emerge for non-core workforce households, though with notably higher cost burdens in the 80-100% AMI range at 19% compared to 8% for core workforce households.

```{r}
#| label: fig-cb
#| fig-cap: "Housing affordability by AMI"

fig_subtitle2 <- paste(
  "Percent of households ",
  "<span style='color: #e9ab3f'><b>cost-burdened</b></span> or",
  "<span style='color: #e76f52'><b>severely cost-burdened</b></span>"
)

pums_faar_hh |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "Core workforce",
      .default = "Not core workforce"
    )
  ) |> 
  mutate(tenure = paste0(tenure, "s")) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(wf, ami_faar, cb_label) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n),
    ymax = cumsum(pct),
    ymin = c(0, head(ymax, n = -1)),
    pct_label = (ymax + ymin)/2
  ) |>
  ungroup() |> 
  filter(cb_label != "Not cost-burdened") |> 
  ggplot(aes(y = ami_faar, x = pct, fill = cb_label)) +
  facet_wrap(~wf, nrow = 2, scales = "free_x") +
  geom_col() +
  geom_text(
    data = . %>% filter(pct > 0.04),
    aes(label = label_percent(accuracy = 1)(pct)),
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  scale_x_continuous(expand = c(0, 0.03)) +
  scale_fill_manual(values = c(cb_pal[1], cb_pal[2])) +
  labs(
    title = "Housing affordability by AMI",
    subtitle = fig_subtitle2,
    caption = pums_cap
  ) +
  add_zero_line("x") +
  theme_hda(
    panel.grid.major.y = element_blank(),
    #axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    strip.text = element_markdown(margin = margin(t = 5))
  )

```

```{r}
#| label: fig-gap-cb
#| fig-cap: "Households who need affordable homes"
#| eval: false

pums_gap_cb <- pums_faar_hh |> 
  filter(
    hh_income > 0,
    #tenure == 'Renter',
    cb_label != "Not cost-burdened"
  ) |> 
  #mutate(tenure = paste0(tenure, "s")) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(core_workforce, ami_faar) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  ungroup() |> 
  mutate(
    pct = n/sum(n),
    ymax = cumsum(pct),
    ymin = c(0, head(ymax, n = -1)),
    pct_label = (ymax + ymin)/2
  ) |>
  mutate(
    core_workforce = case_match(
      core_workforce,
      core_workforce = T ~ "Core workforce",
      .default = "Not core workforce"
    )
  )

pums_gap_cb |> 
  ggplot(aes(x = n, y = ami_faar, fill = fct_rev(core_workforce))) +
  geom_col() +
  geom_text(
    data = . %>% filter(n > 500),
    aes(label = label_comma()(n)),
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  scale_x_continuous(expand = c(0,0)) +
  scale_fill_hda(-1, guide = guide_legend(reverse = T)) +
  labs(
    title = "Households who need affordable homes",
    subtitle = "Number of households paying more than 30% of income on housing",
    caption = pums_cap
  ) +
  theme_hda(
    panel.grid.major.y = element_blank(),
    legend.position = "top",
    legend.justification = "left",
    axis.text.x = element_blank()
  )

```

## Rental housing gap

Wage and rent growth patterns across the Fredericksburg region from 2015 to 2024 reveal a concerning dynamic of persistent unaffordability. While both metrics demonstrate parallel upward trajectories, with cumulative increases ranging from 30-50% across localities, this synchronization effectively absorbed most household income gains into housing costs.

This pattern is particularly evident in Fredericksburg proper, where the close tracking between wage and rent growth meant that households earning the average annual wage saw minimal improvement in their discretionary income after accounting for housing expenses.

The parallel growth trajectories effectively locked in existing affordability challenges, as wage increases that might have provided relief from housing cost burdens were instead captured by proportional rent increases. This dynamic appears most pronounced in urban centers like Fredericksburg and Stafford, where the close coupling between wage and rent growth perpetuated, rather than alleviated, existing patterns of housing stress for cost-burdened households.

```{r}

# Load wage data

faar_wages_yr <- read_rds("data/faar_qcew.rds") |> 
  filter(period == "annual")

faar_wages_qtr <- read_rds("data/faar_qcew.rds") |> 
  filter(period == "quarterly") |> 
  #filter(year > 2019) |> 
  group_by(name) |> 
  arrange(name, year, qtr) |> 
  mutate(chg = avg_annual_pay - first(avg_annual_pay), # Cumulative change
         pct_wage = chg / first(avg_annual_pay)) # Percent change

# Load rent data

faar_rent_qtr <- read_rds("data/faar_costar.rds") |>
  select(1:3, 7:8) |> 
  filter(name != "Region") |> 
  #filter(year > 2019) |> 
  group_by(name) |> 
  arrange(name, year, qtr) |> 
  mutate(chg = asking_rent_per_unit - first(asking_rent_per_unit), # Cumulative change
         pct_rent = chg / first(asking_rent_per_unit)) |>  # Percent change
  select(1:3, 7)

rent_inc <- faar_wages_qtr |> 
  select(name, year, qtr, pct_wage) |> 
  left_join(faar_rent_qtr) |> 
  pivot_longer(
    cols = 4:5,
    names_to = "type",
    values_to = "pct_chg"
  ) |> 
  mutate(yrqtr = paste0(year, " Q", qtr))

```

```{r}
#| label: fig-rent-inc
#| fig-cap: "Wage growth versus rent growth by locality"

fig_subtitle3 <- paste(
  "Percent change in ",
  "<span style='color: #445ca9'><b>median asking rent</b></span> and",
  "<span style='color: #8baeaa'><b>average annual wage</b></span> ",
  "from 2015 Q1 to 2024 Q1"
)

ggplot(rent_inc, aes(x = yrqtr, y = pct_chg, color = type, group = type)) +
  facet_wrap(~name) +
  geom_line() +
  scale_color_hda() +
  scale_y_continuous(
    limits = c(-0.15, 0.61),
    breaks = seq(-0.1, 0.5, 0.1),
    labels = label_percent()
  ) +
  add_zero_line() +
  theme_hda(
    axis.text.x = element_blank()
  ) +
  labs(
    title = "Wage growth versus rent growth by locality",
    subtitle = fig_subtitle3,
    caption = "**Sources:** BLS Quarterly Census of Employment and Wages; CoStar Group, Inc."
  )

```

The rental housing gap analysis reveals severe shortages for lower-income households in the region. The deficit is most acute for households at 30% AMI or below, with a shortfall of approximately 5,600 affordable units. This shortage gradually diminishes at higher income levels, with about 2,300 units needed for households between 31-50% AMI and roughly 450 units for the 51-80% AMI bracket. In contrast, households above 80% AMI have access to abundant affordable and very affordable rental options, suggesting a significant mismatch between housing supply and the needs of lower-income residents.

```{r}
#| label: fig-rent-gap
#| fig-cap: "Rental housing gap by AMI"

faar_chas |> 
  mutate(
    estimate = case_when(
      gapcode == "Gap" ~ estimate * -1,
      gapcode == "Matches or less than income" ~ estimate
    )
  ) |> 
  summarise(
    estimate = sum(estimate),
    .by = c(household_income, match)
  ) |> 
  mutate(
    match = factor(match, c("Unaffordable", "Affordable", "Very affordable"))
  ) |> 
  #filter(household_income != "80% AMI or greater") |> 
  ggplot(aes(x = estimate, y = household_income, fill = fct_rev(match))) +
  geom_col() +
  geom_text(
    data = . %>% filter(estimate < 0),
    aes(label = label_comma()(estimate)),
    color = hda_pal[5],
    nudge_x = -300,
    hjust = 1
  ) +
  scale_fill_manual(
    values = c(hda_pal[1], hda_pal[2], hda_pal[5]),
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_x_continuous(
    limits = c(-7000, 14500),
    labels = label_comma()
  ) +
  add_zero_line("x") +
  theme_hda(
    flip_gridlines = T,
    legend.position = "top"
  ) +
  labs(
    title = "Rental housing gap by AMI",
    subtitle = "Affordability of current home for all renters in region",
    caption = "**Source:** U.S Department of Housing and Urban Development, Comprehensive Housing Affordability Strategy (CHAS), Table 18C."
  )


# To wipe out cost burden among all renters, at least **8,300 new affordable rentals** would be needed. This can be achieved by the development of dedicated affordable housing, as well as direct rental assistance to households.

```

::: {.callout-note}
### Affordability categories

*Unaffordable* — Housing costs exceed the maximum affordable threshold for that household's AMI level  
*Affordable* — Housing costs align with or fall slightly below the household's AMI level  
*Very affordable* — Housing costs fall substantially below what the household could afford at their AMI level

:::

### Core workforce rental affordability

. . .


## Homeownership gap

. . .

### Core workforce homeownership affordability

. . .
