# Core workforce spectrum {#sec-spectrum-work}

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

source("_common.R")

# Load packages other than tidyverse and hdatools

library(tidycensus)
library(srvyr)
library(ggridges)
library(waffle)

# Load PUMS data
pums_faar <- read_rds("data/pums/pums_faar.rds")

# Household records only
pums_faar_hh <- pums_faar |> filter(SPORDER == 1)

# Load PUMS data
pums_wf_hh_types <- read_rds("data/pums/pums_wf_hh_types.rds")

pums_cap <- "**Source:** HDAdvisors calculations of 2018-2022 ACS 5-year data."

```

This chapter assesses the housing spectrum for the region's *core workforce*. This includes all households where at least one member is employed at a job also located within the region. 

::: {.callout-tip}
### Defining the "core workforce"

For every record of an employed person, the Public Use Microdata Sample (PUMS) includes a variable for the place-of-work Public Use Microdata Area ("POWPUMA"). Households with at least one person who has worked in the last 12 months *and* whose POWPUMA values correspond to the Fredericksburg area (Planning District 16) were designated as members of the core workforce.
:::

## Overview

### Identifying the core workforce

Overall commuting trends --- 2/3 of all workers are in core workforce

```{r}
#| label: fig-pow-jobs
#| fig-cap: "Place of work for job holders who live in region"

pums_faar |> 
  filter(!is.na(pow_label)) |> 
  mutate(
    pow_label = case_match(
      pow_label,
      "Fredericksburg area" ~ pow_label,
      "Northern Virginia" ~ "Northern Virginia and D.C.",
      "Washington, DC " ~ "Northern Virginia and D.C.",
      "Maryland" ~ "Another state",
      "Another state" ~ pow_label,
      .default = "Somewhere else in Virginia"
    )
  ) |> 
  to_survey(type = "person", design = "rep_weights") |>
  group_by(pow_label) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  ungroup() |> 
  mutate(
    pct = n/sum(n)
  ) |> 
  ggplot(aes(x = pct, y = fct_reorder(pow_label, pct), fill = pow_label)) +
  geom_col() +
  geom_text(
    aes(label = label_percent()(pct), color = pow_label),
    size = rel(12/2.835),
    hjust = 0,
    nudge_x = 0.01
  ) +
  scale_fill_hda(-1) +
  scale_color_hda(-1) +
  scale_y_discrete(labels = label_wrap(16)) +
  scale_x_continuous(
    limits = c(0, 0.75),
    expand = c(0, 0),
    labels = label_percent()
    ) +
  add_zero_line("x") +
  labs(
    title = "Place of work for job holders who live in region",
    subtitle = "All workers over 16",
    caption = pums_cap
  ) +
  theme_hda(
    flip_gridlines = T,
    axis.text.y = element_text(size = rel(1.25))
  )

```

When sorted into their respective households --- most households are part of core workforce (79,545, 60.2%)

```{r}
#| label: fig-wf-hh
#| fig-cap: "Households in the core workforce"

# pums_faar_hh |>
#   to_survey(type = "housing", design = "rep_weights") |>
#   group_by(core_workforce, hh_earners) |> 
#   summarise(
#     n = survey_total(vartype = "cv")
#   ) 

pums_faar_hh |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "At least one earner in core workforce",
      hh_earners < 1 ~ "No earners",
      .default = "All earners work outside region"
    )
  ) |> 
  #filter(core_workforce == TRUE) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(wf) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  ungroup() |> 
  mutate(
    pct = n/sum(n),
    color = case_when(
      wf == "At least one earner in core workforce" ~ "1",
      .default = "0"
    )
  ) |> 
  ggplot(aes(x = pct, y = fct_reorder(wf, pct), fill = color, color = color)) +
  geom_col() +
  geom_text(
    aes(label = label_percent()(pct)),
    size = rel(14/2.835),
    hjust = 0,
    nudge_x = 0.01
  ) +
  scale_fill_hda(-1) +
  scale_color_hda(-1) +
  scale_y_discrete(labels = label_wrap(16)) +
  scale_x_continuous(
    limits = c(0, 0.75),
    expand = c(0, 0),
    labels = label_percent()
    ) +
  add_zero_line("x") +
  labs(
    title = "Households in the core workforce",
    subtitle = "All households in GWRC region",
    caption = pums_cap
  ) +
  theme_hda(
    flip_gridlines = T,
    axis.text.y = element_text(size = rel(1.25))
  )

```

### Common industries and occupations

Most workers employed at private for-profit businesses in the region

```{r}
#| label: fig-wkr-class
#| fig-cap: "Class of workers in core workforce"

pums_faar |> 
  filter(last_work == "Within year" & wkr_class != "Non-earner") |> 
  to_survey(type = "person", design = "rep_weights") |>
  group_by(wkr_class) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  ungroup() |> 
  mutate(
    pct = n/sum(n)
  ) |> 
  ggplot(aes(x = pct, y = fct_reorder(wkr_class, pct))) +
  geom_col(
    fill = hda_pal[1]
  ) +
  geom_text(
    aes(label = label_percent()(pct)),
    color = hda_pal[1],
    size = rel(12/2.835),
    hjust = 0,
    nudge_x = 0.01
  ) +
  scale_fill_hda() +
  scale_color_hda() +
  scale_y_discrete(labels = label_wrap(16)) +
  scale_x_continuous(
    limits = c(0, 0.75),
    expand = c(0, 0),
    labels = label_percent()
    ) +
  add_zero_line("x") +
  labs(
    title = "Class of workers in core workforce",
    subtitle = "All workers over 16 who worked in last 12 months",
    caption = pums_cap
  ) +
  theme_hda(
    flip_gridlines = T,
    axis.text.y = element_text(size = rel(1.25))
  )

```

Most common industries where core workforce is employed

```{r}
#| label: tbl-wf-ind
#| tbl-cap: "Top five most common core workforce industry groups"

library(formattable)

pums_faar |> 
  filter(pow_label == "Fredericksburg area") |> 
  to_survey(type = "person", design = "rep_weights") |>
  group_by(naics_group) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n)
  ) |>
  slice_max(pct, n = 5) |> 
  mutate(
    n = comma(n, digits = 0),
    pct = percent(pct, digits = 0)
  ) |> 
  select(-3) |> 
  kbl(
    col.names = c("Industry group", "Workers", "Percent"),
    align = "lrr"
  ) |>
  kable_styling(c("condensed", "striped"), full_width = T)

```

Most common job types of core workforce --- across all industries

```{r}
#| label: tbl-wf-occ
#| tbl-cap: "Top five most common core workforce occupational groups"

pums_faar |> 
  filter(pow_label == "Fredericksburg area") |> 
  to_survey(type = "person", design = "rep_weights") |>
  group_by(soc_group) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n)
  ) |>
  slice_max(pct, n = 5) |> 
  mutate(
    n = comma(n, digits = 0),
    pct = percent(pct, digits = 0)
  ) |> 
  select(-3) |> 
  kbl(
    col.names = c("Occupational group", "Workers", "Percent"),
    align = "lrr"
  ) |>
  kable_styling(c("condensed", "striped"), full_width = T)

```

### Income

Core workforce households more likely to have incomes above 120% AMI, otherwise distribution is similar to households whose workers all have jobs outside of the region

```{r}
#| label: fig-wf-ami
#| fig-cap: "Households by workforce status and AMI"

ami_cols <- c(
  "Above 120% AMI" = "#445ca9",
  "100-120% AMI" = "#7a83b9",
  "80-100% AMI" = "#aaacc8",
  "50-80% AMI" = "#e3b5a9",
  "30-50% AMI" = "#e8937d",
  "Below 30% AMI" = "#e76f52"
  )

pums_faar_hh |> 
  filter(hh_income > 0) |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "At least one earner in core workforce",
      hh_earners < 1 ~ "No earners",
      .default = "All earners work outside region"
    )
  ) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(wf, ami_faar) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n)
  ) |> 
  ungroup() |> 
  mutate(
    wf = fct_relevel(
      wf,
      "At least one earner in core workforce",
      "All earners work outside region",
      "No earners"
    )
  ) |> 
  ggplot(aes(x = pct, y = fct_rev(wf), fill = fct_rev(ami_faar))) +
  geom_col(
    aes(alpha = wf)
  ) +
  geom_text(
    aes(label = label_percent(accuracy = 1)(pct)),
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(labels = label_wrap(16)) +
  scale_fill_manual(
    values = ami_cols,
    guide = guide_legend(nrow = 1, reverse = TRUE)
  ) +
  scale_alpha_manual(
    values = c(
      "At least one earner in core workforce" = 1,
      "All earners work outside region" = 0.55,
      "No earners" = 0.55
    ),
    guide = "none"
  ) +
  labs(
    title = "Households by workforce status and AMI",
    subtitle = "Percent of households by income category",
    caption = pums_cap
  ) +
  theme_hda(
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = rel(1.25))
  )

```


### Household characteristics

Most households in core workforce are headed by couples who both hold jobs in the region

```{r}
#| label: tbl-wf-hh-type
#| tbl-cap: "Five most common core workforce household types"

pums_wf_hh_types |> 
  summarise(
    n = sum(n),
    .by = c(hh_type, minors, hh_earners)
  ) |> 
  mutate(pct = n/sum(n)) |> 
  slice_max(pct, n = 5) |> 
  select(1:3, 5) |> 
  mutate(pct = percent(pct, digits = 0)) |> 
  kbl(
    col.names = c("Household type", "Children", "Earners", "Percent"),
    align = "lllc"
  ) |> 
  kable_styling(c("condensed", "striped"))

```


### Affordability

...

```{r}
#| label: fig-wf-costs
#| fig-cap: "Housing costs by workforce status and AMI"

fig_subtitle <- paste(
  "Median housing costs for",
  "<span style='color: #445ca9'><b>core workforce</b></span>,",
  "<span style='color: #8baeaa'><b>non-core workforce</b></span>, and",
  "<span style='color: #e9ab3f'><b>non-earner</b></span>",
  "households"
)

pums_faar_hh |> 
  filter(hh_income > 0) |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "At least one earner in core workforce",
      hh_earners < 1 ~ "No earners",
      .default = "All earners work outside region"
    ),
    costs = case_when(
      cost_own == -1 ~ cost_rent,
      .default = cost_own
    )
  ) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(wf, ami_faar) |> 
  summarise(
    wm = survey_median(costs, vartype = "cv"),
    q = survey_quantile(costs, c(0.25, 0.75))
  ) |> 
  ungroup() |> 
  mutate(
    wf = fct_relevel(
      wf,
      "No earners",
      "All earners work outside region",
      "At least one earner in core workforce"
    )
  ) |> 
  ggplot(aes(x = wm, y = ami_faar, color = wf)) +
  geom_point(size = rel(2), position = position_dodge2(0.5)) +
  geom_segment(
    aes(y = ami_faar, x = q_q25, xend = q_q75, alpha = wf),
    linewidth = rel(1.5),
    lineend = "round",
    position = position_dodge2(0.5)
  ) +
  scale_color_hda(-1) +
  scale_alpha_manual(
    values = c(
      "At least one earner in core workforce" = 0.8,
      "All earners work outside region" = 0.3,
      "No earners" = 0.3
    )
  ) +
  scale_x_continuous(
    limits = c(300, 2800),
    breaks = seq(500, 2500, 500),
    expand = c(0, 0),
    labels = label_dollar(),
    position = "top"
  ) +
  labs(
    title = "Housing costs by workforce status and AMI",
    x = "Lines show range containing 50% of typical housing costs",
    subtitle = fig_subtitle,
    caption = pums_cap
  ) +
  theme_hda(
    flip_gridlines = T,
    axis.text.y = element_text(size = rel(1.2)),
    axis.title.x = element_text(margin = margin(b = 5))
  )

```

...

```{r}
#| label: fig-wf-cb
#| fig-cap: "Housing affordability for core workforce by AMI"

fig_subtitle3 <- paste(
  "Percent of households ",
  "<span style='color: #e9ab3f'><b>cost-burdened</b></span> or",
  "<span style='color: #e76f52'><b>severely cost-burdened</b></span>"
)

pums_faar_hh |> 
  filter(core_workforce == TRUE) |> 
  mutate(tenure = paste0(tenure, "s")) |> 
  to_survey(type = "housing", design = "rep_weights") |>
  group_by(ami_faar, cb_label) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n),
    ymax = cumsum(pct),
    ymin = c(0, head(ymax, n = -1)),
    pct_label = (ymax + ymin)/2
  ) |>
  ungroup() |> 
  filter(cb_label != "Not cost-burdened") |> 
  ggplot(aes(x = ami_faar, y = pct, fill = cb_label)) +
  facet_wrap(~ami_faar, nrow = 1, scales = "free_x") +
  geom_col() +
  geom_text(
    data = . %>% filter(pct > 0.04),
    aes(label = label_percent(accuracy = 1)(pct)),
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  scale_y_continuous(expand = c(0,0.03)) +
  scale_fill_manual(values = c(cb_pal[1], cb_pal[2])) +
  labs(
    title = "Housing affordability for core workforce by AMI",
    subtitle = fig_subtitle3,
    caption = pums_cap
  ) +
  add_zero_line() +
  theme_hda(
    panel.grid.major.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text = element_markdown(margin = margin(t = 5))
  )

```

```{r}
#| eval: false

pums_faar_hh |>
  filter(hh_income > 0) |> 
  mutate(
    wf = case_when(
      core_workforce == TRUE ~ "Core workforce",
      hh_earners < 1 ~ "Not in workforce",
      .default = "Non-core workforce"
    )
  ) |> 
  filter(wf != "Not in workforce") |> 
  ggplot(aes(x = hh_income, y = wf, fill = wf)) +
  facet_wrap(~ami_faar, scales = "free_x") +
  geom_density_ridges2(
    aes(weight = PWGTP, scale = 2, rel_min_height = 0.01),
    color = NA,
    alpha = 0.75,
    linewidth = 0.75
  ) +
  #geom_density_ridges2(
  #  data = . %>% filter(wf == "Non-core workforce"),
  #  aes(x = hh_income, y = ami_faar, weight = PWGTP, scale = 1.25, rel_min_height = 0.01),
  #  fill = NA,
  #  color = hda_pal[2],
  #  alpha = 0.5,
  #  linewidth = 0.5
  #) +
  #geom_density_ridges2(
  #  data = . %>% filter(wf == "Core workforce"),
  #  aes(x = hh_income, y = ami_faar, weight = PWGTP, scale = 1.25),
  #  fill = hda_pal[1],
  #  color = NA,
  #  alpha = 0.75,
  #  linewidth = 0.75
  #) +
  #geom_text(
  #  data = ami_wm,
  #  aes(x = wm, y = ami_faar, label = paste0(label_dollar()(wm), "\n", "|")),
  #  color = "white",
  #  size = 3,
  #  lineheight = 0.8,
  #  nudge_y = 0.2
  #) +
  scale_fill_hda() +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(
    #breaks = c(0, 20000, 40000, 60000, 80000),
    expand = c(0.01, 0),
    labels = label_dollar(scale = 0.001, suffix = "k"),
    position = "bottom"
  ) +
  labs(
    title = "Distribution of household incomes by AMI",
    subtitle = "Median household incomes in white",
    caption = pums_cap
  ) +
  theme_hda(
    panel.grid.major = element_blank(),
    legend.position = "top",
    axis.text.x = element_text(size = 11, vjust = 0, margin = margin(b = 10)),
    axis.text.y = element_blank()
  )

```



## Below 30% AMI

...

```{r}
#| label: tbl-below-30
#| tbl-cap: "Three most common core workforce household types below 30% AMI"

fn_tbl_wf_ami <- function(level){
  
  pums_wf_hh_types |> 
    filter(ami_faar == level) |> 
    slice_max(pct, n = 3) |> 
    select(2:4, 6) |> 
    mutate(pct = percent(pct, digits = 0)) |> 
    kbl(
      col.names = c("Household type", "Children", "Earners", "Percent"),
      align = "lllc"
    ) |> 
    kable_styling(c("condensed", "striped"))

}

fn_tbl_wf_ami("Below 30% AMI")

```


...

```{r}
#| label: tbl-below-30-occ
#| tbl-cap: "Ten most common core workforce occupations below 30% AMI"

pums_wf_occ <- pums_faar |> 
  filter(pow_label == "Fredericksburg area") |> 
  to_survey(type = "person", design = "rep_weights") |>
  group_by(ami_faar, soc) |> 
  summarise(
    n = survey_total(vartype = "cv")
  ) |> 
  mutate(
    pct = n/sum(n)
  ) |>
  group_by(ami_faar) |> 
  slice_max(pct, n = 10, with_ties = F) |> 
  mutate(
    rank = row_number(desc(n)),
    col = case_when(
      rank < 6 ~ "A",
      .default = "B"
    )
  ) |> 
  ungroup() |> 
  mutate(
    soc = paste0(rank, ". ", str_remove(soc, "^.*?-"))
  ) 

fn_tbl_wf_occ <- function(level){
  
  pums_wf_occ |> 
    filter(ami_faar == level) |> 
    select(1, 2, 7) |> 
    group_by(col) |> 
    mutate(pos = row_number()) |> 
    ungroup() |> 
    pivot_wider(
      names_from = col,
      values_from = soc,
      id_cols = pos
    ) |> 
    select(-1) |> 
    kbl(
      col.names = c("Ten Most Common Occupations", ""),
      align = "ll"
    ) |> 
    kable_styling(c("condensed", "striped"))

}

fn_tbl_wf_occ("Below 30% AMI")

```

## 30-50% AMI

...

```{r}
#| label: tbl-30-50
#| tbl-cap: "Three most common core workforce household types between 30-50% AMI"

fn_tbl_wf_ami("30-50% AMI")

```

...

```{r}
#| label: tbl-30-50-occ
#| tbl-cap: "Ten most common core workforce occupations between 30-50% AMI"

fn_tbl_wf_occ("30-50% AMI")

```

## 50-80% AMI

...

```{r}
#| label: tbl-50-80
#| tbl-cap: "Three most common core workforce household types between 50-80% AMI"

fn_tbl_wf_ami("50-80% AMI")

```

...

```{r}
#| label: tbl-50-80-occ
#| tbl-cap: "Ten most common core workforce occupations between 50-80% AMI"

fn_tbl_wf_occ("50-80% AMI")

```

## 80-100% AMI

...

```{r}
#| label: tbl-80-100
#| tbl-cap: "Three most common core workforce household types between 80-100% AMI"

fn_tbl_wf_ami("80-100% AMI")

```

...

```{r}
#| label: tbl-80-100-occ
#| tbl-cap: "Ten most common core workforce occupations between 80-100% AMI"

fn_tbl_wf_occ("80-100% AMI")

```

## 100-120% AMI

...

```{r}
#| label: tbl-100-120
#| tbl-cap: "Three most common core workforce household types between 100-120% AMI"

fn_tbl_wf_ami("100-120% AMI")

```

...

```{r}
#| label: tbl-100-120-occ
#| tbl-cap: "Ten most common core workforce occupations between 100-120% AMI"

fn_tbl_wf_occ("100-120% AMI")

```

## Above 120% AMI

...

Couples with no children but multiple earners would include adult, working children living with their parents

```{r}
#| label: tbl-120
#| tbl-cap: "Three most common core workforce household types above 120% AMI"

fn_tbl_wf_ami("Above 120% AMI")

```

...

Inclusion of some lower-wage jobs here (e.g. cashiers) implies many live with a second earner who brings in relatively more income

```{r}
#| label: tbl-120-occ
#| tbl-cap: "Ten most common core workforce occupations above 120% AMI"

fn_tbl_wf_occ("Above 120% AMI")

```